#! /bin/bash

templatefile="$1"
inputfile="$2"
outputfile="$3"

read -r -d '' AWK_REPL_STR<<EOFCC
{
	mexpr=sprintf(".*%s.*",replacekey);
	if (match(\$0,mexpr)) {
		gsub(replacekey,replacevalue);
		printf("%s\n",\$0);
	} else {
		printf("%s\n",\$0);
	}
}
EOFCC

tmpfile=`mktemp`
# first to input the value
cat "$templatefile" | sed 's/\\$/%endslash%/g' | sed 's/"\$/%quotedollar%/g'  | sed 's/\\\$/%dollarslash%/g' | sed 's/\\n/%newline%/g' | sed 's/\\/\\\\/g' | sed 's/\&/%specialcase%/g' > $tmpfile
replaceval=$(cat "$tmpfile" )
awk -v replacekey='%EXTARGSPARSE%' -v replacevalue="$replaceval" "$AWK_REPL_STR" "$inputfile"  | sed 's/%newline%/\\n/g' |   sed 's/%endslash%/\\\\/g' |  sed 's/%dollarslash%/\\\\\\\$/g' | sed 's/%specialcase%/\&/g' | sed 's/%quotedollar%/"\\\$/g' >"$outputfile"
rm -f "$tmpfile"
#echo "tmpfile ($tmpfile)" >&2
